<!-- TODO move styles elsewhere-->
<style>
  #icon-choices {}
  #icon-choices .glyphicon {
    float: left;
    display:inline-block;
    margin:3vw;
    font-size:6.25vw;
  }
  .selected {
    color:lightgreen;
  }

/*  #timeline {
    height:70vh;
    width:90vw;
    border:1vw solid darkgrey;
    overflow: scroll;
  }*/
</style>




<main id="timeline">
  
  <%if session[:user_id]%>

    <!-- timeline -->
    <%= render "home/timeline" %>
  <%else%>

    <!-- Describe what Timekeep is about -->

    <h3>Time is money; track your spending.</h3>

    <p>Timekeep is a web app that helps you track how you spend your time. It is primarily a mobile web app because in this day and age, everyone is always on their phones. Periodically note what you've done in the past hour or two, and be honest: how much of that time did you spend surfing the web? Be honest and write that down in Timekeep. As you use Timekeep more and more, you'll become more mindful of your time-spending habits and become more aware when you are goofing off. Time is money; track your spending.</p>

    <h3>You are not logged in: click on settings on the top right to sign up or log in!</h3>

  <%end%>


  <!-- hidden new entry modal -->
  <%= render 'home/modal_partials/new_entry' %>

  <!-- hidden new category modal -->
  <%= render 'home/modal_partials/new_category' %>

</main>







<!-- TODO move script elsewhere-->
<script>
  var timeSlotStart,
      timeSlotEnd; //used to set default time




  /*this funciton takes inputs and then returns the start and endtime */
  function getEntryDuration(startHour, startMinute, durationHHMM){


    var starttimeSlot = startHour + ":" + startMinute;


    var duration = durationHHMM, // "1::30" = 1 hour 30 mins
        durationHour = duration.split('::')[0],
        durationMinute = duration.split('::')[1];


    var endtimeHour,
        endtimeMinute,
        endtimeSlot;

    endtimeHour = parseInt(startHour) + parseInt(durationHour);
    
    endtimeMinute = parseInt(startMinute) + parseInt(durationMinute);
    if (parseInt(endtimeMinute) >= 60) {
      endtimeHour += 1;
      endtimeMinute -= 60;
    }

    

    if (parseInt(endtimeHour) > 23) {
      endtimeHour = "23";
    } else if (endtimeHour.toString().length === 1) {
      endtimeHour = "0" + endtimeHour;
    }

    if (endtimeMinute.toString().length === 1) {
      endtimeMinute += "0";
    }
    endtimeSlot = endtimeHour + ":" + endtimeMinute;


    return {
      "starttime": starttimeSlot,
      "endtime": endtimeSlot
     }
  }

  Date.prototype.toDateInputValue = (function() {
    var local = new Date(this);
    local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
    return local.toJSON().slice(0,10);
  });


  $(document).ready(function(){
    var newEntryForm = $('#new-entry-form'),
        newEntryModal = $('#new-entry');

    /* event listener: NEW ENTRY MODAL */
    $('.hour').on('click', function(){

      var startHour = this.id.split('-')[1],
          startMinute = "00", 
          duration = "1::00"; //entry defaults to an hour

      // Autopopulate [starttime, endtime, entry_date]
      var durations = getEntryDuration(startHour, startMinute, duration);
      $('input[name="starttime"]').val(durations['starttime']);
      $('input[name="endtime"]').val(durations['endtime']);
      $('input[name="entry_date"]').val( new Date().toDateInputValue() );

      newEntryModal.modal('toggle');
    });

    /* event listener: submitting new entry form */
    $('#new-entry-submit').on('click', function(){
      var categoryId = $('select[name="category_id"]').val(),
          formAction = newEntryForm.attr('action'),
          formAction = formAction.split('categories/')[0];
          formAction += 'categories/' + categoryId + '/entries';


      newEntryForm.attr('action', formAction);
      newEntryForm.submit();
    });


    /* event listener: NEW CATEGORY MODAL */
    $('#new-category-btn').on('click', function(){
      newEntryModal.modal('toggle');
      $('#new-category').modal('toggle');

    });


    /* start scrolled depending on current time */
    setScrollStart();


    /* show the activities on the timeline for today */
    var sessionId = $('#session-id').val();
    $.ajax('/users/' + sessionId + '/data_hash', {
      success: function(data) {
        var nowDate = new Date()
        console.log('ajax succeeded');
        dataHash = data;     
           
        setUpTimeline();
      },
      error: function(){
        console.log('ajax failed');
      }
    });

  });

  function setScrollStart(){
    var timeNow = new Date().getHours();

    if (timeNow < 7) {
      window.scrollTo(0, 0);
    } else if (timeNow < 15) {
      window.scrollTo(0, 400);
    } else {
      window.scrollTo(0, 800);
    }
  }

  
    
    
  
  
  function formatDate(date){  
    var dd = date.getDate(),
        mm = date.getMonth() + 1,
        yyyy = date.getFullYear();
    if(dd < 10) {
      dd = '0' + dd
    }
    if(mm < 10) {
      mm = '0' + mm
    }
    date = yyyy + '-' + mm + '-' + dd;
    return date;
  }     

  function setUpTimeline(){
    var date = formatDate( new Date() ),
        datesCatsAndEntries = getDatesCatsAndEntries(date),
        datesCatsAndEntriesLength = datesCatsAndEntries.length;

    var approximateTime = function(time) {
      var hr = parseInt( time.split(':')[0] ),
          mins = parseInt( time.split(':')[1] ),
          newHr = hr,
          newMins,
          newTime;

      if (mins < 15) {
        newMins = "00";
      } else if (mins < 45) {
        newMins = "30";
      } else {
        newMins = "00";
        newHr += 1;
      }

      newHr = newHr.toString();

      if (newHr.length < 2) {
        newHr = "0" + newHr;
      }

      //TODO: what to do if the hour is 24:00
      
      return newHr + ':' + newMins;
    };

    var makeTimeSlotEl = function(starttime, endtime){
      var hoursSlot = $('.hour'),
          hoursSlotLength = hoursSlot.length;

      for (var i = 0; i < hoursSlotLength; i++){
        var hour = $(hoursSlot[i]).find('h6').html(); // "00:00"
        
        if (hour === starttime) {
          //create element for this div
            //attach data from entry into it so when clicked, it can be clicked and its input is prefilled and when saved, it updates the corresponding row in the database

          //then find the element corresponding to the slot before the endtime.
            //create elements for each of these slots in between as above
        }

      }
    }

    //loop through categories
    for (var i = 0; i < datesCatsAndEntriesLength; i++) {

      // approximate time slot; eg. 2:53-4:41 => 3:00-4:30
      
      // loop through entries of the category from datesCatsAndEntries
      var entries = datesCatsAndEntries[i]['entries'],
          entriesLength = datesCatsAndEntries[i]['entries'].length;

      for (var t = 0; i < entriesLength; i++) {
        var thisEntry = entries[t],
            actualStart = thisEntry['starttime'].split('T')[1].substring(0, 5),
            actualEnd = thisEntry['endtime'].split('T')[1].substring(0, 5),
            approxStart,
            approxEnd;


        // calculate a new start and exit time. don't update the time here, because i want to put the original times into the time slot object, so when people click on it, tehy can get the original data
        approxStart = approximateTime(actualStart);
        approxEnd = approximateTime(actualEnd);
        
        //then create the time slot objects
        //TODO
        makeTimeSlotEl(approxStart, approxEnd);
        
      }    
    }
  }



  /*gets categories and entries based on date */
  function getDatesCatsAndEntries(thisDate){
    var catsAndEntries = [];
    //Loop through categories
    for (var cat in dataHash) {
      var thisCategory = {
        'name': dataHash[cat]['name'],
        'color': dataHash[cat]['color'],
        'icon': dataHash[cat]['icon'],
        'entries': []
      };
      //loop through entries in categories
      for (var entry in dataHash[cat]['entries']) {
        var thisEntry = dataHash[cat]['entries'][entry];
        
        //if the date is today's date, insert into array
        if (thisEntry['entry_date'] === thisDate) {
          thisCategory['entries'].push(thisEntry);
        }
      }
      //if the category's entries is greater than zero, insert, else don't.
      if (thisCategory['entries'].length > 0) {
        catsAndEntries.push(thisCategory);
      }
    }
    return catsAndEntries;
  }


</script>


